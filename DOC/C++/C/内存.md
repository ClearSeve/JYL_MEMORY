# 内存

## 定义

程序：在硬盘上可以执行的文件  
进程：在内存中运行起来的程序  
一个进程的内存空间包括以下几个部分：
也可分为代码段，数据段，堆栈段

1. 代码区：程序的代码（函数为基本单位）存入，只读
2. 只读常量区：常量和字符串的字面值
3. 全局区：存放全局变量和static变量，main函数执行前分配全局区
4. bss段：存放未初始化的全局变量，main函数执行前清空bss段（清空为0）
5. 堆：自由分配和回收内存
6. 栈：局部变量，包括函数的参数，自动分配和回收内存

在全局区定义: const  int  i=5； 存于只读常量区  
在函数中定义: const  int  i=5； 存于栈  
在函数内: str[5]=”abc”;  栈（未制造常量）  *str=”abc”;  只读常量区(制造字面值)  

```
代码区
只读常量区
全局区
bss段
堆

栈
```

## 内存的地址

虚拟内存地址
每个进程都设定0到4g的虚拟内存地址（不是内存的真实物理地址，只是一个编号）。0到3g是用户空间，3g到4g是内核空间。虚拟内存地址开始时不对应任何物理内存，直接使用会引发段错误，虚拟内存地址必须映射物理内存（或硬盘上的文件`文件不能小于需要使用的大小`）才能存放数据  
虚拟内存地址相当于为物理内存地址取名，存放的只是数字  
内存分配其实指的是映射物理内存的过程，内存回收是解除映射的过程  

内存管理的最小单位是一个内存页（4k，4096bit），虚拟内存地址连续时，物理内存地址可以不连续

## 内存分配

<stdlib.h>  
malloc:分配内存块，不会对分配内存进行初始化  
   void  *malloc(size_t  size);  
分配成功返回指针，失败返回NULL  
exp：  
int  *p=(int *)malloc(3*sizeof(int));  
可使用 p[0]=1,p[2]=3  

calloc:分配内存块，对内存进行清零  
void *  calloc(size_t  number ,size_t  size);  
为number个元素分配内存，每个大小size，成功则返回指针，失败返回null  
exp：  
int *p=(int *)calloc(3,sizeof(int));  

realloc:调整先前已经分配的内存块大小  
void*  realloc(void  *p ,  size_t  size);  
p指向需要调整的内存块，size为调整后的大小

1. 内存扩张，realloc不会初始化扩张的内存
2. size为0时，释放原来分配的内存
3. 失败返回NULL，不影响原来的数据

释放： void  free(void  *p);

malloc一次映射33个内存页，多余页留下次用，使用完后再次映射，除了数据区，还需额外保存一些信息（如分配内存大小，方便free释放时使用）。所以分配时，上一次malloc与下一次malloc不紧密连接。free是把映射解除，相当于将使用状态切换到未使用状态（数据还在原内存位置，只是此时可以当作空白来覆盖）
如果一次申请页数超过33页，实际分配的内存页数会稍大于申请页数。  
getpagesize()可以获取当前页大小

void  ab(char *p){ p=malloc(1);} 错误  
char* ab(){char *p=malloc(1);return p;} 正确

int  *p=10;  
或者int  *p;  int  a;*p=a;  
不可以这样赋值（段错误）
p有虚拟内存地址，但没有映射物理内存，不能存放数据
